### Multiple ways to give access to your cluster

---

1. RBAC and IAM

2. client and certificates.

#### RBAC and IAM

1. Create IAM User: In Google Cloud, grant access to your project by either creating a user and assigning the cluster admin role or by creating a service account and providing the associated key.json file for authentication.

2. Create Role and Role Binding: Use the IAM user's email generated by Google Cloud in the Role and Role Binding to implement Role-Based Access Control (RBAC).

---

#### Client and Certificates.

1. Generate Key:

`openssl genrsa -out ajay.key 2048`

2. Generate CSR (Certificate Signing Request):

` openssl req -new -key ajay.key -out ajay.csr -subj "/CN=ajay/O=group1"`

3. Sign CSR with Kubernetes CA:

`cat ajay.csr | base64 | tr -d '\n'`

4. Create CertificateSigningRequest:

```
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: ajay
spec:
  request: BASE64_CSR
  signerName: kubernetes.io/kube-apiserver-client
  usages:
  - client auth
```

`kubectl apply -f csr.yaml `

`kubectl certificate approve ajay`

5. Retrieve Certificate:

`kubectl get csr ajay -o jsonpath='{.status.certificate}' | base64 --decode > ajay.crt`

Role and Role Binding

```
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: default
  name: pod-reader
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "watch", "list"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: read-pods
  namespace: default
subjects:
- kind: User
  name: ajay
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io

```

6. Setup kubeconfig

kubectl config set-credentials ajay --client-certificate=ajay.crt --client-key=ajay.key

kubectl config set-context ajay-context --cluster=kubernetes --namespace=default --user=ajay

7. To Generate kubeconfig for user

```
apiVersion: v1
kind: Config
clusters:
- name: my-cluster
  cluster:
    server: https://kube-api.example.com
    certificate-authority-data: <base64-encoded-ca-cert>
users:
- name: friend
  user:
    client-certificate-data: <base64-encoded-client-cert>
    client-key-data: <base64-encoded-client-key>
contexts:
- name: friend-context
  context:
    cluster: my-cluster
    user: friend
current-context: friend-context
```
